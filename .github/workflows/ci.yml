name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run tests
      run: pytest

    - name: Run type checking
      run: mypy whisk/

    - name: Check formatting
      run: black --check whisk/ tests/

  validate-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if version was bumped
      run: |
        # Check if pyproject.toml version changed for significant code changes
        if git diff origin/main...HEAD -- pyproject.toml | grep -q "^+version"; then
          echo "✅ Version was updated in pyproject.toml"
          exit 0
        elif git diff origin/main...HEAD --name-only | grep -qE 'whisk/.*\.py$'; then
          echo "⚠️  Core whisk files changed but version not bumped"
          echo "Consider running: ./scripts/bump_version.sh patch"
          exit 1
        else
          echo "ℹ️  No core changes, version bump not required"
          exit 0
        fi